@* vovkor *@
@*  @model IEnumerable<virdbApp2.Models.maindb> *@
@model PagedList.IPagedList<virdbApp2.Models.maindb>
@using PagedList.Mvc;
@using Microsoft.AspNet.Identity;

@{
    ViewBag.Title = @Resources.Resource.AccessionList;
}

<h3>@Resources.Resource.AccessionList</h3>


@using (Html.BeginForm("Index", "maindb", FormMethod.Get, new { @name = "myForm" }))
{

    <div class="form-group">
        <div class="row">
            <div class="col-md-2">
                @Html.Label(@Resources.Resource.advancedSearch)
            </div>
            <div class="col-md-1">
                @Html.CheckBox("enable_advanced_search") @*, false)*@
            </div>
            <div class="col-md-3">
                
            </div>
            <div class="col-md-1">
            </div>
            <div class="col-md-3">

            </div>
            <div class="col-md-3">
            </div>
        </div>
        <div class="row" id="hiddenSearch1">
            <div class="col-md-2">
                @Html.DropDownList("searchField1", null, htmlAttributes: new { @class = "form-control" })
            </div>
            <div class="col-md-3">
                @Html.TextBox("searchStr1", ViewBag.searchStr1 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr1", ViewBag.searchStrOr1 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr11", ViewBag.searchStrOr11 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
        </div>

        <div class="row" id="hiddenSearch2">
            @* style="display:none" *@
            <div class="col-md-2">
                @Html.DropDownList("searchField2", null, htmlAttributes: new { @class = "form-control" })
            </div>
            <div class="col-md-3">
                @Html.TextBox("searchStr2", ViewBag.searchStr2 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr2", ViewBag.searchStrOr2 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr22", ViewBag.searchStrOr22 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
        </div>

        <div class="row" id="hiddenSearch3">
            <div class="col-md-2">
                @Html.DropDownList("searchField3", null, htmlAttributes: new { @class = "form-control" })
            </div>
            <div class="col-md-3">
                @Html.TextBox("searchStr3", ViewBag.searchStr3 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr3", ViewBag.searchStrOr3 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr33", ViewBag.searchStrOr33 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
        </div>

        <div class="row" id="hiddenSearch4">
            <div class="col-md-2">
                @Html.DropDownList("searchField4", null, htmlAttributes: new { @class = "form-control" })
            </div>
            <div class="col-md-3">
                @Html.TextBox("searchStr4", ViewBag.searchSt4 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr4", ViewBag.searchStrOr4 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr44", ViewBag.searchStrOr44 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
        </div>
        <div class="row" id="hiddenSearch5">
            <div class="col-md-2">
                @Html.DropDownList("searchField5", null, htmlAttributes: new { @class = "form-control" })
            </div>
            <div class="col-md-3">
                @Html.TextBox("searchStr5", ViewBag.searchStr5 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr5", ViewBag.searchStrOr5 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
            <div class="col-md-1" align="right">@Html.Label(@Resources.Resource.Or)</div>
            <div class="col-md-2">
                @Html.TextBox("searchStrOr55", ViewBag.searchStrOr55 as string, htmlAttributes: new { @class = "form-control", placeholder = "" })
            </div>
        </div>
        <div class="row">       </div>
        <br />

        
        <div class="row">
            <div class="col-md-1" id="hiddenPlus">
                <input type="button" name="plus" value="+" onclick="showSearchField(event)" />
            </div>

            <div class="col-md-1">
                @Html.Label(@Resources.Resource.Genus)
            </div>
            <div class="col-md-3">
                @Html.DropDownList("genusChoice", null, htmlAttributes: new { @class = "form-control", placeholder = "Род" })
            </div>

            <div class="col-md-1">
            </div>
            <div class="col-md-2">
                @Html.TextBox("SearchString", ViewBag.CurrentFilter as string, htmlAttributes: new { @class = "form-control", placeholder = @Resources.Resource.Search })
            </div>
            <div class="col-md-1">
                <input type="submit" value=@Resources.Resource.SearchNow class="btn btn-default" />
            </div>
            <div class="col-md-3">
                @Html.Label(@Resources.Resource.CountRecords) @Html.Display("countRecords")
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                @if (User.Identity.GetUserName() != "")
                {
                    @Html.ActionLink(@Resources.Resource.CreateNew, "Create")
                }
            </div>

            <div class="col-md-9">
            </div>
            <div class="col-md-1">
                @Html.TextBox("txtMaxRec", ViewBag.str_max_records as string, htmlAttributes: new { @class = "form-control", placeholder = "", size = 5 }) @* внутри формы, поэтому введенное значение сохраняется после submit *@
            </div>
        </div>
    </div>

}



<table class="table">
    <tr>
        <th>
            @*  @Html.DisplayNameFor(model => model.accenumb) *@
            @Html.ActionLink(@Resources.Resource.accenumb, "Index", new { sortOrder = ViewBag.AccenumbSortParm, currentFilter = ViewBag.CurrentFilter })
        </th>
        <th>
            @Html.ActionLink(@Resources.Resource.NameEng, "Index", new { sortOrder = ViewBag.NameSortParm, currentFilter = ViewBag.CurrentFilter })
        </th>
        <th>
            @* @Html.DisplayNameFor(model => model.accename_rus) *@ 
            @Html.ActionLink(@Resources.Resource.NameRus, "Index", new { sortOrder = ViewBag.NameRusSortParm, currentFilter = ViewBag.CurrentFilter })
        </th>
        <th>
            
            @Html.ActionLink(@Resources.Resource.Crop, "Index", new { sortOrder = ViewBag.CropSortParm, currentFilter = ViewBag.CurrentFilter }) 
        </th>
        <th>
            @Resources.Resource.Taxonomy
        </th>
        <th>
            @Html.ActionLink(@Resources.Resource.AcqDate, "Index", new { sortOrder = ViewBag.DateSortParm, currentFilter = ViewBag.CurrentFilter })
        </th>
        <th>
           @Html.DisplayName(@Resources.Resource.oricode) 
        </th>
 @*     <th>
    @Html.ActionLink("Lat | Long", "Index", new { sortOrder = ViewBag.CoordSortParm, currentFilter = ViewBag.CurrentFilter })
    </th>

    <th>
    @Html.ActionLink("Lat|Long", "Index", new { sortOrder = ViewBag.CoordSortParm, currentFilter = ViewBag.CurrentFilter })
    </th>
*@       
    
        <th width="80px"></th>
    
        
    </tr>

@foreach (var item in Model) {
    <tr>
        <td>
            @Html.DisplayFor(modelItem => item.accenumb)
        </td>
        <td>
            @Html.DisplayFor(modelItem => item.accename_eng)
        </td>
        <td>
            @Html.DisplayFor(modelItem => item.accename_rus)
        </td>
        <td>
            @Html.DisplayFor(modelItem => item.botanic.taxonomy_crop.crop_name_eng)
        </td>
        <td>
            <!-- можно проваливаться -->
            @Html.DisplayFor(modelItem => item.botanic.taxonomy_genus.taxonomy_family.family_name_calc)
            @Html.DisplayFor(modelItem => item.botanic.taxonomy_genus.genus_name_calc)
            @Html.DisplayFor(modelItem => item.botanic.species_calc)
        </td>

        <td>
            @Html.DisplayFor(modelItem => item.GetAcqDate)
        </td>
        <td>
            @Html.DisplayFor(modelItem => item.geography.GEORUS)
        </td>
        @*<td>
    @Html.DisplayFor(modelItem => item.latitude)  @Html.DisplayFor(modelItem => item.longitude)
    </td>
    <td>
    @Html.DisplayFor(modelItem => item.LatLong_calc)
    </td>
        *@

        <!-- 19.02.2015 VAV -->
        @if (User.Identity.GetUserName().Trim().ToUpper() == item.owner_str.Trim().ToUpper())
        {
            <td>   
@*
    @Html.ActionLink("Edit", "Edit", new { id=item.id }) |
    @Html.ActionLink("Details", "Details", new { id=item.id }) |
    @Html.ActionLink("Delete", "Delete", new { id = item.id })
*@
                @Html.Raw(@Html.ActionLink("[replacetext]", "Edit", new { id = item.id }, new { Class = "action edit", title = @Resources.Resource.Edit }).ToHtmlString().Replace("[replacetext]", "<img src=\"/virdb/Images/edit.png\" />"))
                @Html.Raw(@Html.ActionLink("[replacetext]", "Delete", new { id = item.id }, new { Class = "action del", title = @Resources.Resource.Delete }).ToHtmlString().Replace("[replacetext]", "<img src=\"/virdb/Images/trash.png\" />"))
                
            </td>
        }
        else
        {
            <td>
                @* @Html.ActionLink("Details", "Details", new { id = item.id }) *@
                @Html.Raw(@Html.ActionLink("[replacetext]", "Details", new { id = item.id }, new { Class = "action details", title = @Resources.Resource.Details }).ToHtmlString().Replace("[replacetext]", "<img src=\"/virdb/Images/details.png\" />"))
            </td>
        }

    </tr>
}

</table>
<br />
Page @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) of @Model.PageCount

@Html.PagedListPager(Model, page => Url.Action("Index",
    new { page, sortOrder = ViewBag.CurrentSort, currentFilter = ViewBag.CurrentFilter, genusChoice = ViewBag.currentGenus }))


@section scripts {
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    @* vovkor подключаем jquery*@
    <script src="~/Scripts/jquery-1.10.2.min.js" type="text/javascript"></script>
    <script src="~/Scripts/jquery-ui-1.11.2.min.js" type="text/javascript"></script>

    @* автозаполнение  *@
    <link href="../../Content/themes/base/all.css" rel="stylesheet" type="text/css">


    <section class="scripts">
        <script type="text/javascript">
            "use strict";
            /*
            function codeAddress() {
                alert('ok');
            }

            window.onload = codeAddress;
            */
                    // скрыть/показать поля поиска
                    $(function () {
                        // скрывает при загрузке
                        /*
                        $('#hiddenSearch2').hide().click(function (e) {
                            // Метод объекта event stopPropagation останавливает "всплытие" вызова события к родительским элементам
                            // Зачем?
                            e.stopPropagation();
                        });
                        */


                        if (!(document.getElementById("enable_advanced_search").checked)) // если undefined?
                        {
                            $('#hiddenSearch1').hide(); // скрываем div
                            $('#hiddenSearch2').hide(); // скрываем div
                            $('#hiddenSearch3').hide(); // скрываем div
                            $('#hiddenSearch4').hide(); // скрываем div
                            $('#hiddenSearch5').hide(); // скрываем div
                            console.log("скрыли hiddenPlus");
                            $('#hiddenPlus').hide(); // скрываем div
                            console.log(document.getElementById("enable_advanced_search").checked);
                        }

                        
                        
                        if (!($('#searchStr2').val()) && !($('#searchStr1').val())) // если пусто
                        {
                            $('#hiddenSearch2').hide(); // скрываем div
                        }
                        if (!($('#searchStr3').val()) && !($('#searchStr2').val())) // если пусто
                        {
                            $('#hiddenSearch3').hide(); // скрываем div
                        }
                        if (!($('#searchStr4').val()) && !($('#searchStr3').val())) // если пусто
                        {
                            $('#hiddenSearch4').hide(); // скрываем div
                        }
                        if (!($('#searchStr5').val()) && !($('#searchStr4').val())) // если пусто
                        {
                            $('#hiddenSearch5').hide(); // скрываем div
                        }

                         //$('#hiddenSearch4').fadeOut();
                         //$('#hiddenSearch5').fadeOut();

                    });

                    function getRealDisplay(elem) {
                        if (elem.currentStyle) {
                            return elem.currentStyle.display
                        } else if (window.getComputedStyle) {
                            var computedStyle = window.getComputedStyle(elem, null)
                            return computedStyle.getPropertyValue('display')
                        }
                    }


                    function showSearchField(e) {
                        /*
                        if (!($('#searchStr1').val())) {
                            $('#hiddenSearch2').show(1000);
                        }
                        else if (!($('#searchStr2').val())) {
                            $('#hiddenSearch3').show(1000);
                        }
                        else if (!($('#searchStr3').val())) {
                            $('#hiddenSearch4').show(1000);
                        }
                        else if (!($('#searchStr4').val())) {
                            $('#hiddenSearch5').show(1000);
                        }
                        */
                        console.log("showSearchField")
                        var hSearch1 = document.getElementById("hiddenSearch1");
                        var hSearch2 = document.getElementById("hiddenSearch2");
                        var hSearch3 = document.getElementById("hiddenSearch3");
                        var hSearch4 = document.getElementById("hiddenSearch4");
                        if (getRealDisplay(hSearch4) != 'none') {
                            $('#hiddenSearch5').show(1000);
                        }
                        if (getRealDisplay(hSearch3) != 'none') {
                            $('#hiddenSearch4').show(1000);
                        }
                        if (getRealDisplay(hSearch2) != 'none') {
                            $('#hiddenSearch3').show(1000);
                        }

                        if (getRealDisplay(hSearch1) != 'none')
                        {
                            $('#hiddenSearch2').show(1000);
                        }

                    }
                    // назначить функцию событию
                    document.getElementById("enable_advanced_search").addEventListener("click", showAdvancedSearch);

                    function showAdvancedSearch(e) {
                        //console.log("showAdvancedSearch");
                        var enabled = e.target.checked;
                        if (enabled) {
                            $('#hiddenSearch1').show(1000);
                            $('#hiddenPlus').show(1000);
                            
                        }
                        else {
                            $('#hiddenSearch1').hide(); // скрываем div
                            $('#searchStr1').val(''); $('#searchStrOr1').val(''); $('#searchStrOr11').val('');
                            $('#hiddenSearch2').hide(); // скрываем div
                            $('#searchStr2').val(''); $('#searchStrOr2').val(''); $('#searchStrOr22').val('');
                            $('#hiddenSearch3').hide(); // скрываем div
                            $('#searchStr3').val(''); $('#searchStrOr3').val(''); $('#searchStrOr33').val('');
                            $('#hiddenSearch4').hide(); // скрываем div
                            $('#searchStr4').val(''); $('#searchStrOr4').val(''); $('#searchStrOr44').val('');
                            $('#hiddenSearch5').hide(); // скрываем div
                            $('#searchStr5').val(''); $('#searchStrOr5').val(''); $('#searchStrOr55').val('');
                            $('#hiddenPlus').hide(); // скрываем div
                        }
                    }

            // Автозаполнение
            // будет передан один аргумент term и доп аргумент в функцию AutocompleteSearchStr
            //Также знак доллара используется для получения доступа к главному объекту jQuery. $(id) означает document.getElementById(id)
                    var autocomplete_search = function (sStr, sField) {
                        $(sStr).keypress(function () {
                            var target = $(this);
                            var sField1 = $(sField).val();
                            var queryString = { sField: sField1 };
                            //Для передачи доп аргумента используем +'/?'+$.param()
                            var url = '@Url.Action("AutocompleteSearchStr", "maindb")' + '/?' + $.param(queryString);
                            //console.log("при выборе searchStr1") // Отладка скрипта
                            //console.log(sField1) // Отладка скрипта
                            // вызываем для target
                            target.autocomplete({ // для target вызываем autocomplete.
                                source: url,
                                minLength: 1,
                                //source: target.attr("data-autocomplete-source"), minLength: 2,
                                // .change() вызовет событие change после программного изменения поля '.itemExpedId'
                                //select: function (event, ui) { $(this).closest('form').find('.itemExpedId').val(ui.item.id).change(); },
                                //change: function (event, ui) { console.log(ui.item.value); }
                                //focus: function (event, ui) {this.value = ui.item.value;}, при наведении фокуса на элемент выпадающего списка значение подставляется в поле
                            });

                        });
                    };

                    $(document).ready(function () {
                        autocomplete_search("#searchStr1", "#searchField1");
                        autocomplete_search("#searchStrOr1", "#searchField1");
                        autocomplete_search("#searchStrOr11", "#searchField1");
                        autocomplete_search("#searchStr2", "#searchField2");
                        autocomplete_search("#searchStrOr2", "#searchField2");
                        autocomplete_search("#searchStrOr22", "#searchField2");
                        autocomplete_search("#searchStr3", "#searchField3");
                        autocomplete_search("#searchStrOr3", "#searchField3");
                        autocomplete_search("#searchStrOr33", "#searchField3");
                        autocomplete_search("#searchStr4", "#searchField4");
                        autocomplete_search("#searchStrOr4", "#searchField4");
                        autocomplete_search("#searchStrOr44", "#searchField4");
                        autocomplete_search("#searchStr5", "#searchField5");
                        autocomplete_search("#searchStrOr5", "#searchField5");
                        autocomplete_search("#searchStrOr55", "#searchField5");
                    });

        </script>

    </section>
} 